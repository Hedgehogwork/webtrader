{"version":3,"sources":["../../../../src/cashier/currency.es6"],"names":["require","check_promise","check_currency_async","Promise","resolve","reject","$html","html","win","windows","createBlankWindow","dialogClass","width","height","resizable","collapsable","minimizable","maximizable","modal","ignoreTileAction","close","dialog","remove","destroy","win_view","unbind","state","disabled","value","array","continue","liveapi","send","set_account_currency","then","oauth","local_storage","get","currency","set","cached","authorize","catch","err","$","growl","error","message","cancel","notice","i18n","payout_currencies","data","forEach","config","currency_obj","type","push","categories","_","uniqBy","map","e","rv","formatters","format_category","category","capitalize","bind","check_currency"],"mappings":"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","file":"currency.js","sourcesContent":["import $ from 'jquery';\nimport liveapi from 'websockets/binary_websockets';\nimport windows from 'windows/windows';\nimport rv from 'common/rivetsExtra';\nimport html from 'text!cashier/currency.html';\nimport _ from 'lodash';\n\nrequire(['common/util']);\n\nlet check_promise = null;\nconst check_currency_async = () => new Promise((resolve, reject) => {\n  var $html = $(html);\n  var win = windows.createBlankWindow($html, {\n    dialogClass: \"dialog-confirm\",\n    width: 500,\n    height: 210,\n    resizable: false,\n    collapsable: false,\n    minimizable: false,\n    maximizable: false,\n    modal: true,\n    ignoreTileAction: true,\n    close: () => {\n      win.dialog('destroy');\n      win.remove();\n      win = null;\n    },\n    destroy: () => {\n      win_view && win_view.unbind();\n      win_view = null;\n    }\n  });\n\n  var state = {\n    disabled: true,\n    value: 'Select a value',\n    array: ['Select a value'],\n    continue: () => {\n      state.disabled = true;\n      liveapi.send({ set_account_currency: state.value })\n        .then(() => {\n          // This doesn't work because on emitting the login event currency is reset.\n          // local_storage.set(\"currency\", state.value);\n          const oauth = local_storage.get('oauth');\n          oauth[0].currency = state.value;\n          local_storage.set(\"oauth\", oauth);\n          //Re-authorize\n          liveapi.cached.authorize(true)\n          win.dialog('close');\n        })\n        .catch((err) => {\n          reject();\n          win.dialog('close');\n          $.growl.error({ message: err.message });\n        });\n    },\n    cancel: () => {\n      reject();\n      win.dialog('close');\n      $.growl.notice({ message: 'Please set currency.'.i18n() });\n    }\n  };\n\n  liveapi.cached.send({ payout_currencies: 1 }).then((data) => {\n    state.disabled = false;\n    state.array = [];\n    data.payout_currencies.forEach((currency) => {\n      const config = local_storage.get(\"currencies_config\") || {};\n      const currency_obj = {\n        value: currency,\n        type: config[currency] ? config[currency].type : ''\n      };\n      state.array.push(currency_obj);\n    });\n    state.categories = _.uniqBy(state.array, \"type\").map((e) => e.type);\n    state.value = data.payout_currencies[0];\n  }).catch(() => reject({ message: 'Please try again after few minutes.'.i18n() }));\n\n  rv.formatters.format_category = (category) => {\n    return _.capitalize(category) + \" Currencies\"\n  };\n\n  var win_view = rv.bind($html[0], state);\n  win.dialog('open');\n});\n\nexport const check_currency = () => {\n  if (check_promise) { return check_promise; }\n  check_promise = check_currency_async().then(() => check_promise = null).catch((err) => {\n    check_promise = null;\n  });\n  return check_promise;\n}\n\nexport default {\n  check_currency\n}\n"]}