define(["exports","jquery","windows/windows","websockets/binary_websockets","charts/chartingRequestMap","common/rivetsExtra","moment","../charts/chartSettings","trade/lookback","common/util"],function(a,b,c,d,e,f,g,h,i){"use strict";function j(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[c]=a[c]);return b["default"]=a,b}function k(a){return a&&a.__esModule?a:{"default":a}}function l(a,b){K(a,b);var c=b.chart.chart;c&&(m(a,b,c),n(a,b,c),Q(a,b))}function m(a,b,c){function d(a){var d=a.spot_time,e=a.label,f=a.color;if(d&&!b.chart.hasLabel(e)){var g=c.series[0].data.find(function(a){return+a.x===+(1e3*d)});if(g){var h=v.getMarkerSettings(f);g.update({marker:h})}}}var e=a.entry_tick_time,f=a.exit_tick_time;d({spot_time:e,label:"entry_tick_time",color:"white"}),d({spot_time:f,label:"exit_tick_time",color:"orange"})}function n(a,b,c){function d(a){var d=a.line_time,e=a.label,f=a.dashStyle;return!d||b.chart.hasLabel(e)?!1:void c.addPlotLineX({value:1e3*d,dashStyle:f})}var e=a.date_expiry,f=a.date_start;d({line_time:f,label:"start_time"}),d({line_time:e,label:"end_time",dashStyle:"Dash"})}function o(a,b){function c(b){var c=+b.proposal_open_contract.contract_id!==+a.proposal_open_contract.contract_id;if(!c)return b.error?void G(b.error.message):void H(b,a)}O=c,r["default"].proposal_open_contract.subscribe(b.contract_id),r["default"].events.on("proposal_open_contract",O)}Object.defineProperty(a,"__esModule",{value:!0}),a.init=void 0;var p=k(b),q=k(c),r=k(d),s=k(e),t=k(f),u=k(g),v=j(h),w=k(i),x=Object.assign||function(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var d in c)Object.prototype.hasOwnProperty.call(c,d)&&(a[d]=c[d])}return a},y=function(){function a(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!b||c.length!==b);d=!0);}catch(i){e=!0,f=i}finally{try{!d&&h["return"]&&h["return"]()}finally{if(e)throw f}}return c}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();require(["css!viewtransaction/viewTransaction.css"]),require(["text!viewtransaction/viewTransaction.html"]);var z={},A=3,B={EXPIRED:"This contract has expired".i18n(),MARKET_RATE:"Note: Contract will be sold at the prevailing market price when the request is received by our servers. This price may differ from the indicated price.".i18n(),NO_RESALE:"Resale of this contract is not offered".i18n(),FINISHED:"This contract has expired".i18n()},C=null,D=function(){if(C)return void C.moveToTop();var a="There was a market data disruption during the contract period. For real-money accounts we will attempt to correct this and settle the contract properly, otherwise the contract will be cancelled and refunded. Virtual-money contracts will be cancelled and refunded.".i18n(),b=p["default"]('<div class="data-disruption-dialog">'+a+"</div>");C=q["default"].createBlankWindow(b,{title:" There was an error ".i18n(),height:200,resizable:!1,collapsable:!1,minimizable:!1,maximizable:!1,destroy:function(){C&&C.dialog("destroy").remove(),C=null},"data-authorized":"true"}),C.dialog("open"),window.dd=C},E=function(a,b,c){var d=[],e="",f=0;if(c.history){e="line";for(var g=c.history,h=g.times,i=g.prices,j=0;j<h.length;++j)d.push([1e3*h[j],1*i[j]]),f=Math.max(f,i[j].substring(i[j].indexOf(".")+1).length)}c.candles&&(e="candlestick",d=c.candles.map(function(a){return[1e3*a.epoch,1*a.open,1*a.high,1*a.low,1*a.close]}));var k=c.title,l=a.find(".transaction-chart")[0],m=["start_time","entry_spot","barrier","exit_spot","end_time"],n={credits:{href:"#",text:""},chart:{type:"line",renderTo:l,backgroundColor:null,width:0,height:0,marginLeft:65,marginRight:20},title:{text:""},subtitle:{text:v.getLabelEl(m),useHTML:!0},tooltip:{useHTML:!0,formatter:function(){var a=addComma(this.y.toFixed()),b=u["default"].utc(this.x).format("dddd, MMM D, HH:mm:ss");return"<div class='tooltip-body'>"+b+" GMT<br/>"+this.series.name+" "+a+"</div>"}},xAxis:{type:"datetime",categories:null,startOnTick:!1,endOnTick:!1,min:d.length?d[0][0]:null,max:d.length?d[d.length-1][0]:null,labels:{overflow:"justify",format:"{value:%H:%M:%S}"}},yAxis:{labels:{align:"left",x:-65,y:-2,formatter:function(){return addComma(this.value.toFixed(A))}},title:""},series:[{name:k,data:d,type:e,zIndex:10}],exporting:{enabled:!1,enableImages:!1},legend:{enabled:!1},navigator:{enabled:!0},plotOptions:{line:{marker:{radius:2}},candlestick:{lineColor:"black",color:"red",upColor:"green",upLineColor:"black",shadow:!0}},rangeSelector:{enabled:!1}},o=new Highcharts.Chart(n);return o.addPlotLineX=function(a){o.xAxis[0].addPlotLine({value:a.value,id:a.id||a.value,color:a.color||"#e98024",zIndex:0,width:a.width||2,dashStyle:a.dashStyle})},o.addPlotLineY=function(a){o.yAxis[0].addPlotLine({id:a.id,value:a.value,color:a.color||"green",zIndex:0,width:2,dashStyle:a.dashStyle})},l.chart=o},F=a.init=function(a,b){return new Promise(function(c,d){return z[b]?(z[b].moveToTop(),void c()):void r["default"].send({proposal_open_contract:1,contract_id:a}).then(function(a){var d=a.proposal_open_contract;return void 0===d.underlying&&void 0===d.shortcode?void D(d):(d.transaction_id=b,L(d),void c())})["catch"](function(a){p["default"].growl.error({message:a.message}),d()})})},G=function(a){p["default"].growl.error({message:a}),r["default"].proposal_open_contract.forget(data.echo_req.contract_id),r["default"].proposal_open_contract.subscribe(data.echo_req.contract_id)},H=function(a,b){function c(a,b){b.proposal_open_contract.user_sold=a.exit_tick_time&&a.exit_tick_time<a.date_expiry,b.proposal_open_contract.current_spot=a.current_spot,b.proposal_open_contract.current_spot_time=a.current_spot_time,b.proposal_open_contract.bid_price=a.bid_price,b.proposal_open_contract.entry_tick=a.entry_tick,b.proposal_open_contract.entry_tick_time=a.entry_tick_time,b.proposal_open_contract.status=a.status,b.proposal_open_contract.is_sold=a.is_sold,b.proposal_open_contract.exit_tick=a.exit_tick,b.proposal_open_contract.exit_tick_time=a.exit_tick_time,b.proposal_open_contract.date_expiry=a.date_expiry,b.proposal_open_contract.sell_price=a.sell_price,b.proposal_open_contract.is_valid_to_sell=a.is_valid_to_sell,b.proposal_open_contract.barrier=a.barrier,b.proposal_open_contract.high_barrier=a.high_barrier,b.proposal_open_contract.low_barrier=a.low_barrier,b.note=J(a)}function d(){if(f.bid_price){b.sell.bid_price.value=f.bid_price;var a=f.bid_price.toString().split(/[\.,]+/),c=y(a,2);b.sell.bid_price.unit=c[0],b.sell.bid_price.cent=c[1]}}function e(){var a=f.is_forward_starting&&+f.date_start>+f.current_spot_time;return a?void(b.fwd_starting="* Contract has not started yet".i18n()):void(b.fwd_starting="")}var f=a.proposal_open_contract;c(f,b),l(f,b);var g="open"!==f.status;return g?void I(b):(d(),e(),void b.chart.manualReflow())},I=function(a){a.proposal_open_contract.is_ended=!0,a.sell.sell_at_market_enabled=!1},J=function(a){return a.validation_error?a.validation_error:"open"!==a.status?B.FINISHED:a.is_expired||a.is_sold?B.EXPIRED:a.is_valid_to_sell?B.MARKET_RATE:a.is_valid_to_sell?void 0:B.NO_RESALE},K=function(a,b){b.sell.bid_prices.length>40&&b.sell.bid_prices.shift(),b.sell.bid_prices.push(a.bid_price)},L=function(a){require(["text!viewtransaction/viewTransaction.html"],function(b){var c=p["default"](b).i18n(),d=N(a,c),e=q["default"].createBlankWindow(c,{title:a.display_name+" ("+a.transaction_id+")",width:700,minWidth:490,minHeight:480,height:480,destroy:function(){},close:function(){f&&f.unbind(),r["default"].proposal_open_contract.forget(a.contract_id),r["default"].events.off("proposal_open_contract",O);for(var b=0;b<d.onclose.length;++b)d.onclose[b]();p["default"](this).dialog("destroy").remove(),z[a.transaction_id]=void 0},open:function(){r["default"].proposal_open_contract.forget(a.contract_id)},resize:function(){d.chart.manualReflow()},"data-authorized":"true"});e.dialog("open");var f=t["default"].bind(c[0],d);z[a.transaction_id]=e})},M=function(a,b){a.sell.sell_at_market_enabled=!1,require(["text!viewtransaction/viewTransactionConfirm.html","css!viewtransaction/viewTransactionConfirm.css"]),r["default"].send({sell:a.proposal_open_contract.contract_id,price:0}).then(function(c){a.proposal_open_contract.user_sold=!0;var d=c.sell;require(["text!viewtransaction/viewTransactionConfirm.html","css!viewtransaction/viewTransactionConfirm.css"],function(c){var e=a.proposal_open_contract,f=e.buy_price,g=e.longcode,h=e.currency,i={longcode:g,buy_price:f,sell_price:d.sold_for,return_percent:(100*(d.sold_for-f)/f).toFixed(2)+"%",transaction_id:d.transaction_id,balance:d.balance_after,currency:h},j=p["default"](c).i18n();b.after(j);var k=t["default"].bind(j[0],i);a.onclose.push(function(){k&&k.unbind()})})})["catch"](function(a){p["default"].growl.error({message:a.message})})},N=function(a,b){var c={route:{value:"table",update:function(a){c.route.value=a}},note:J(a),chart:{chart:null,loading:"Loading "+a.display_name+" ...",added_labels:[],hasLabel:function(a){return c.chart.added_labels.includes(a)?!0:(c.chart.added_labels.push(a),!1)},type:"ticks",manualReflow:function(){if(c.chart.chart){var a=-1*(b.find(".longcode").height()+b.find(".tabs").height()+b.find(".footer").height())-16,d=b,e=d.width()-10,f=d.height();return c.chart.chart.setSize(e,f+a,!1),c.chart.chart.hasUserSize=null,c.chart.chart.series[0]&&0===c.chart.chart.series[0].data.length?void c.chart.chart.showLoading():void c.chart.chart.hideLoading()}}},proposal_open_contract:x({},a,{currency:(a.currency||"USD")+" ",is_ended:a.is_settleable||a.is_sold||"open"!==a.status,is_sold_at_market:!1,user_sold:a.exit_tick_time&&a.exit_tick_time<a.date_expiry,isLookback:w["default"].isLookback(a.contract_type),lb_formula:w["default"].formula(a.contract_type,a.multiplier&&formatPrice(a.multiplier,a.currency||"USD"))}),sell:{bid_prices:[],bid_price:{unit:void 0,cent:void 0,value:void 0},sell:function(){return M(c,b)},sell_at_market_enabled:!0},onclose:[]};return R(c,b),c},O=void 0,P=function(a,b){function c(){if(s["default"][h])s["default"].subscribe(h);else{var c=d(b,a.proposal_open_contract.underlying);s["default"].register(c)["catch"](function(a){p["default"].growl.error({message:a.message})})}}function d(a,b){return{symbol:b,subscribe:1,granularity:a,style:0===a?"ticks":"candles"}}function e(){function b(a,b){a&&a.series[0].addPoint([1e3*b.epoch,1*b.quote])}i=r["default"].events.on("tick",function(c){if(c.tick&&c.tick.symbol===a.proposal_open_contract.underlying){var d=a.chart.chart,e=a.proposal_open_contract,f=e.status,h=e.is_sold,i=e.exit_tick,j=e.exit_tick_time,k=c.tick,l=h||"open"!==f||i||j;return l?void g():void b(d,k)}})}function f(){j=r["default"].events.on("ohlc",function(b){var c=s["default"].keyFor(b.ohlc.symbol,b.ohlc.granularity);if(h===c){var d=a.chart.chart;if(d){var e=d.series[0],f=e.data[e.data.length-1],i=b.ohlc,j=[1e3*i.open_time,1*i.open,1*i.high,1*i.low,1*i.close];f.x!==j[0]?e.addPoint(j,!0,!0):f.update(j,!0);var k=a.proposal_open_contract,l=k.status,m=(k.is_sold,k.exit_tick),n=k.exit_tick_time,o=k.date_expiry,p=1*i.epoch>1*o||"open"!==l||m||n;p&&g()}}})}function g(){k||(k=!0,s["default"].unregister(h),i&&r["default"].events.off("tick",i),j&&r["default"].events.off("candles",j))}var h=s["default"].keyFor(a.proposal_open_contract.underlying,b);c(h);var i=void 0,j=void 0,k=!1;return a.onclose.push(g),0===b?void e():void f()},Q=function(a,b){function c(a,b,c){function d(a,b,c){e.addPlotLineY({id:a,value:b,color:c})}a&&d("barrier",a),b&&d("high_barrier",b),c&&d("low_barrier",c)}function d(a,b,c){a&&e.yAxis[0].removePlotLine("barrier"),b&&e.yAxis[0].removePlotLine("high_barrier"),c&&e.yAxis[0].removePlotLine("low_barrier")}var e=b.chart.chart,f=b.proposal_open_contract,g=f.barrier,h=f.high_barrier,i=f.low_barrier;d(g,h,i),c(g,h,i)},R=function(a,b){function c(a){var b=0;return b=3600>=a?0:7200>=a?60:21600>=a?120:86400>=a?300:3600}function d(a,b){var c=0;return c=0===b?Math.max(3,30*a/3600|0):3*b}function e(b,c){var d=a.proposal_open_contract,e=d.is_forward_starting,f=d.date_start,g=d.current_spot_time,h=d.purchase_time,i=d.exit_tick_time,j=e&&+f>+g||+f>+i,k=j?+h:+f||+h,l=k>i||!i?"latest":+i+c,m={adjust_start_time:1,ticks_history:a.proposal_open_contract.underlying,start:k-c,end:l,style:"ticks",count:4999};return 0!==b&&(m.granularity=b,m.style="candles",a.chart.type="candles"),m}function f(c){function d(a,b){return x({title:b},a)}a.chart.loading="";var e=d(c,a.proposal_open_contract.display_name),f=E(b,a,e);a.chart.chart=f,a.chart.manualReflow()}function g(b){a.chart.loading=b.message}var h=Math.min(+a.proposal_open_contract.date_expiry,u["default"].utc().unix())-(a.proposal_open_contract.purchase_time||a.proposal_open_contract.date_start),i=c(h),j=d(h,i),k=e(i,j);a.proposal_open_contract.is_ended||P(a,i),r["default"].send(k).then(function(b){f(b),o(a,a.proposal_open_contract)})["catch"](function(a){g(a)})};a["default"]={init:F}});