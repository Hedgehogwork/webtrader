define(["exports","../websockets/binary_websockets","../windows/windows","../common/rivetsExtra","lodash","text!./login.html","css!./login.css"],function(a,b,c,d,e,f){"use strict";function g(a){return a&&a.__esModule?a:{"default":a}}function h(){var a=i["default"].app_id,b=new URL(window.location.href).hostname,c=b.includes("binary.me")?".me":".com",d=i["default"].server_url.includes("qa")?i["default"].server_url:"oauth.binary"+c,e="https://"+d+"/oauth2/authorize",f=(local_storage.get("i18n")||{value:"en"}).value;window.location=e+"?app_id="+a+"&l="+f}Object.defineProperty(a,"__esModule",{value:!0}),a.init=void 0,a.login=h;var i=g(b),j=g(c),k=g(d),l=g(e),m=g(f),n=null,o=null,p=a.init=function(){if(n)return void n.moveToTop();var a=$(m["default"]).i18n();n=j["default"].createBlankWindow(a,{title:"Log in",resizable:!1,collapsable:!1,minimizable:!1,maximizable:!1,width:548,height:"auto",close:function(){n.dialog("destroy"),n.remove(),n=null},open:function(){},destroy:function(){o&&o.unbind(),o=null}}),n.parent().css("overflow","visible"),q(a,n),n.dialog("open");var b=n.dialog("widget").offset();b.top=120,n.dialog("option","position",{my:b.left,at:b.top}),n.dialog("widget").css({left:b.left+"px",top:b.top+"px"}),n.dialog("widget").find(".ui-selectmenu-menu ul").css("max-height","320px")},q=function(a,b){var c=i["default"].app_id,d={route:{value:"login"},login:{disabled:!1},registration:{email:"",disabled:!1,validate:{value:!1},email_show_explanation:function(){var a=d.registration.email;return""===a&&!d.registration.validate.value||validateEmail(a)}},account:{empty_fields:{validate:!1,clear:l["default"].debounce(function(){d.account.empty_fields.validate=!1},2e3),show:function(){d.account.empty_fields.validate=!0,d.account.empty_fields.clear()}},password_error_message:function(){var a=d.account.password;return""===a?d.account.empty_fields.validate?"You should enter between 6-25 characters.".i18n():"":a.length<6?"Password must be 6 characters minimum".i18n():/\d/.test(a)&&/[a-z]/.test(a)&&/[A-Z]/.test(a)?"":"Password must contain lower and uppercase letters with numbers".i18n()},verification:"",password:"",repeat_password:"",residence:"",residence_list:[{text:"Indonesia",value:"id"}],residence_unsupported:[],disabled:!1},confirm:{disabled:!1}};d.login.login=function(){d.login.disabled=!0,h()},d.confirm.confirm=function(){d.confirm.disabled=!0;var a=i["default"].server_url,b="https://"+a+"/oauth2/authorize";window.location=b+"?app_id="+c},d.route.update=function(a){var c={login:{title:"Log in".i18n(),height:180},registration:{title:"Registration".i18n(),height:220},account:{title:"Account opening".i18n(),height:465},confirm:{title:"Account opening".i18n(),height:415}};d.route.value=a;var e=c[a].title,f=c[a].height;b.dialog("option","title",e),b.dialog("option","height",f)},d.registration.validate.clear=l["default"].debounce(function(){d.registration.validate.value=!1},2e3),d.registration.validate.show=function(){d.registration.validate.value=!0,d.registration.validate.clear()},d.registration.create=function(){var a=d.registration.email;return""!=a&&validateEmail(a)?(d.registration.disabled=!0,void i["default"].send({verify_email:a,type:"account_opening"}).then(function(b){if(d.registration.disabled=!1,!b.verify_email)throw{message:"Email verification failed".i18n()+" ("+b.msg_type+")"};$.growl.notice({message:"Verification code sent to ".i18n()+a}),d.route.update("account")})["catch"](function(a){$.growl.error({message:a.message}),d.registration.disabled=!1})):void d.registration.validate.show()},d.account.open=function(){d.account.empty_fields.show();var a=d.registration.email,c=d.account.verification,e=d.account.password,f=d.account.repeat_password,g=d.account.residence,h=validateEmail(a)&&""!==c&&e===f&&e.length>=6;if(h=h&&/\d/.test(e)&&/[a-z]/.test(e)&&/[A-Z]/.test(e)&&2===g.length){var j={new_account_virtual:1,verification_code:c,client_password:e,residence:g};d.account.disabled=!0,i["default"].send(j).then(function(a){var c=a.new_account_virtual,e=[{id:c.client_id,token:c.oauth_token}];local_storage.set("oauth",e),d.account.disabled=!1,i["default"].cached.authorize().then(function(){b.dialog("destroy"),b.remove(),n=null})["catch"](function(a){return void 0})})["catch"](function(a){$.growl.error({message:a.message}),d.account.disabled=!1})}},o=k["default"].bind(a[0],d),i["default"].cached.send({residence_list:1}).then(function(a){d.account.residence_list=a.residence_list.map(function(a){return a.disabled="DISABLED"===a.disabled||a.disabled===!0,a.disabled&&d.account.residence_unsupported.push(a.value),a}),d.account.residence="id",i["default"].cached.send({website_status:1}).then(function(a){var b=a.website_status&&a.website_status.clients_country;-1===d.account.residence_unsupported.indexOf(b)&&(d.account.residence=b||"id")})["catch"](function(a){d.account.residence="id"})})["catch"](function(a){$.growl.error({message:a.message})})};a["default"]={init:p,login:h}});