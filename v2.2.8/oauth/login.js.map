{"version":3,"sources":["../../../../src/oauth/login.es6"],"names":["login","login_win","login_win_view","app_id","liveapi","hostname","URL","window","location","href","domain_extension","includes","login_url","server_url","oauth_url","lang","local_storage","get","value","init","moveToTop","root","$","html","i18n","windows","createBlankWindow","title","resizable","collapsable","minimizable","maximizable","width","height","close","dialog","remove","open","destroy","unbind","parent","css","init_state","offset","top","my","left","at","find","win","state","route","disabled","registration","email","validate","email_show_explanation","validateEmail","account","empty_fields","clear","_","debounce","show","password_error_message","password","length","test","verification","repeat_password","residence","residence_list","text","residence_unsupported","confirm","update","routes","create","send","verify_email","type","then","data","growl","notice","message","msg_type","catch","err","console","error","ok","request","new_account_virtual","verification_code","client_password","oauth","id","client_id","token","oauth_token","set","cached","authorize","rv","bind","map","r","push","website_status","clients_country","indexOf"],"mappings":"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","file":"login.js","sourcesContent":["/*\n * Created by amin on May 1, 2016.\n */\n\nimport liveapi from '../websockets/binary_websockets';\nimport windows from '../windows/windows';\nimport rv from '../common/rivetsExtra';\nimport _ from 'lodash';\nimport html from 'text!./login.html';\nimport 'css!./login.css';\n\nlet login_win = null;\nlet login_win_view = null; // rivets view\n\nexport function login() {\n      const app_id = liveapi.app_id;\n      const hostname = new URL(window.location.href).hostname;\n      const domain_extension = hostname.includes('binary.me') ? '.me' : '.com';\n      const login_url = liveapi.server_url.includes('qa') ? liveapi.server_url : `oauth.binary${domain_extension}`;\n      const oauth_url = `https://${login_url}/oauth2/authorize`;\n      const lang = (local_storage.get('i18n') || { value:'en' }).value;\n      window.location =  oauth_url + '?app_id=' + app_id + '&l=' +lang;\n}\n\nexport const init = () => {\n   if(login_win){\n      login_win.moveToTop();\n      return;\n   }\n\n   const root = $(html).i18n();\n   login_win = windows.createBlankWindow(root, {\n      title: 'Log in',\n      resizable:false,\n      collapsable:false,\n      minimizable: false,\n      maximizable: false,\n      width: 548,\n      height: 'auto',\n      close: () => {\n         login_win.dialog('destroy');\n         login_win.remove();\n         login_win = null;\n      },\n      open: () => { },\n      destroy: () => {\n         login_win_view && login_win_view.unbind();\n         login_win_view = null;\n      }\n   });\n   login_win.parent().css('overflow', 'visible');\n\n   init_state(root, login_win);\n   login_win.dialog('open');\n\n   /* update dialog position, this way when dialog is resized it will not move*/\n   const offset = login_win.dialog('widget').offset();\n   offset.top = 120;\n   login_win.dialog(\"option\", \"position\", { my: offset.left, at: offset.top });\n   login_win.dialog('widget').css({\n      left: offset.left + 'px',\n      top: offset.top + 'px'\n   });\n   login_win.dialog('widget').find('.ui-selectmenu-menu ul').css('max-height', '320px');\n}\n\nconst init_state = (root, win) => {\n   const app_id = liveapi.app_id;\n   const state = {\n      route: { value: 'login' },\n      login: { disabled: false },\n      registration: {\n         email: '',\n         disabled: false,\n         validate: { value: false },\n         email_show_explanation: () => {\n            const email = state.registration.email;\n            return (email === '' && !state.registration.validate.value) || validateEmail(email);\n         },\n      },\n      account: {\n         empty_fields: {\n            validate: false,\n            clear: _.debounce(() => {\n               state.account.empty_fields.validate = false;\n            }, 2000),\n            show: () => {\n               state.account.empty_fields.validate = true;\n               state.account.empty_fields.clear();\n            }\n         },\n         password_error_message: () => {\n            const password = state.account.password;\n            if(password === '') return state.account.empty_fields.validate ? 'You should enter between 6-25 characters.'.i18n() : '';\n            if(password.length < 6) return 'Password must be 6 characters minimum'.i18n();\n            if(!/\\d/.test(password) || !/[a-z]/.test(password) || !/[A-Z]/.test(password)) return 'Password must contain lower and uppercase letters with numbers'.i18n();\n            return '';\n         },\n         verification: '',\n         password: '',\n         repeat_password:  '',\n         residence: '',\n         residence_list: [ { text: 'Indonesia', value: 'id'}],\n         residence_unsupported: [],\n         disabled: false, /* is button disabled */\n      },\n      confirm: { disabled: false }\n   };\n\n   state.login.login = () => {\n      state.login.disabled = true;\n      login();\n   }\n\n   state.confirm.confirm = () => {\n      state.confirm.disabled = true;\n      const server_url = liveapi.server_url;\n      const oauth_url = `https://${server_url}/oauth2/authorize`;\n      window.location =  oauth_url + '?app_id=' + app_id;\n   }\n\n   state.route.update = (route) => {\n      const routes = {\n         login: {\n            title: 'Log in'.i18n(),\n            height: 180\n         },\n         registration: {\n            title: 'Registration'.i18n(),\n            height: 220,\n         },\n         account: {\n            title: 'Account opening'.i18n(),\n            height: 465\n         },\n         confirm: {\n            title: 'Account opening'.i18n(),\n            height: 415\n         }\n      };\n      state.route.value = route;\n      const title = routes[route].title;\n      const height = routes[route].height;\n      win.dialog('option', 'title', title);\n      win.dialog('option', 'height', height);\n   };\n\n   state.registration.validate.clear = _.debounce(() => {\n      state.registration.validate.value = false;\n   }, 2000);\n\n   state.registration.validate.show = () => {\n      state.registration.validate.value = true;\n      state.registration.validate.clear();\n   }\n\n   /* { verify_email: 'email' } step */\n   state.registration.create = () => {\n      const email = state.registration.email;\n      if(email == '' || !validateEmail(email)) {\n         state.registration.validate.show();\n         return;\n      }\n\n      state.registration.disabled = true;\n      liveapi.send({verify_email: email, type: 'account_opening'})\n         .then((data) => {\n            state.registration.disabled = false;\n            if(data.verify_email) {\n               $.growl.notice({ message: 'Verification code sent to '.i18n() + email });\n               state.route.update('account');\n            }\n            else  {\n               throw { message: `${'Email verification failed'.i18n()} (${data.msg_type})` };\n            }\n         })\n         .catch((err) => {\n            console.error(err);\n            $.growl.error({ message: err.message });\n            state.registration.disabled = false;\n         });\n   }\n\n   /* { new_account_virtual: 1 } step */\n   state.account.open = () => {\n      state.account.empty_fields.show();\n      const email = state.registration.email,\n         verification = state.account.verification,\n         password = state.account.password,\n         repeat_password = state.account.repeat_password,\n         residence = state.account.residence;\n      let ok = validateEmail(email) && verification !== '' && password === repeat_password && password.length >= 6;\n      ok = ok && /\\d/.test(password) && /[a-z]/.test(password) && /[A-Z]/.test(password)  && residence.length === 2;\n\n      if(!ok) { return; }\n\n      const request = {\n         new_account_virtual: 1,\n         verification_code: verification,\n         client_password: password,\n         residence: residence,\n         // affilate_token: '???'\n      };\n      state.account.disabled = true;\n      liveapi.send(request)\n         .then((data) => {\n            const account = data.new_account_virtual;\n            const oauth = [{id: account.client_id, token: account.oauth_token }];\n            local_storage.set('oauth', oauth);\n            state.account.disabled = false;\n            liveapi.cached.authorize()\n               .then(() => {\n                  win.dialog('destroy'); \n                  win.remove();\n                  login_win = null;\n               })\n               .catch(\n                  (err) => console.error(err.message)\n               );\n            //state.route.update('confirm');\n         })\n         .catch((err) => {\n            console.error(err);\n            $.growl.error({ message: err.message });\n            state.account.disabled = false;\n         });\n   }\n\n   login_win_view = rv.bind(root[0], state);\n\n   liveapi.cached.send({residence_list: 1})\n      .then((data) => {\n         state.account.residence_list = data.residence_list.map((r) => {\n            r.disabled = (r.disabled === 'DISABLED' || r.disabled === true);\n            r.disabled && state.account.residence_unsupported.push(r.value);\n            return r;\n         });\n         state.account.residence = 'id'; // make indonesia default\n         liveapi.cached.send({website_status: 1})\n            .then((data) => {\n               const residence = data.website_status && data.website_status.clients_country;\n               if(state.account.residence_unsupported.indexOf(residence) === -1)\n                  state.account.residence = residence || 'id';\n            })\n            .catch((err) => {\n               console.error(err);\n               state.account.residence = 'id';\n            })\n      })\n      .catch((err) => {\n         console.error(err);\n         $.growl.error({ message: err.message });\n      });\n}\n\nexport default {\n   init,\n   login\n}\n"]}